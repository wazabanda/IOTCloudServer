{% extends "core/base.html" %} 
{% block content %}
<style>
    /* Add any additional styles here */
    .custom-background {
      background-color: #3490dc; /* Blue color, change as needed */
    }
    .plotly-graph {
      width: 100%;
      height: 300px;
      margin-bottom: 1rem;
    }
</style>
<div class="flex justify-between items-center mb-6">
    <h4 class="text-4l font-extrabold leading-none tracking-tight text-gray-900 md:text-5xl lg:text-6xl">
        {{device}} Readings
    </h4>
    <a href="{% url 'device_detail' device.id %}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
        Manage Device
    </a>
</div>

<!-- Load Plotly.js -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<div id="chart_container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6 bg-white p-4 shadow"></div>

{% if has_location_data %}
<div class="mt-6 bg-white p-4 shadow">
    <h4 class="text-lg font-medium text-gray-900 mb-4">Location Data</h4>
    <p class="text-gray-500">Location data is available for this device.</p>
    <div id="map" class="w-full h-64 mt-4"></div>
</div>
{% endif %}

<div id="buttons" class="mt-6 bg-white p-4 shadow">
    <h4 class="text-lg font-medium text-gray-900 mb-4">GPIO Controls</h4>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for pin in gpiopins %}
        <div class="p-4 border-b border-gray-200">
            <p class="font-medium text-gray-900">{{ pin.name }} (Pin {{ pin.pin }})</p>
            <div class="flex items-center mt-2">
                <input type="checkbox" id="toggleButton{{ pin.pin }}" class="hidden">
                <label for="toggleButton{{ pin.pin }}" class="cursor-pointer">
                    <div id="toggleButtonContainer{{ pin.pin }}" class="w-12 h-6 bg-gray-300 rounded-full p-1 duration-300 ease-in-out">
                        <div id="toggleIndicator{{ pin.pin }}" class="bg-white w-5 h-5 rounded-full shadow-md transform translate-x-0 duration-300 ease-in-out"></div>
                    </div>
                </label>
            </div>
        </div>
        {% empty %}
        <p class="text-gray-500 col-span-full">No GPIO pins configured for this device. <a href="{% url 'device_detail' device.id %}" class="text-blue-500 hover:underline">Add pins</a></p>
        {% endfor %}
    </div>
</div>

{%include "core/socket.html"%}
<script>
  const plotsMap = new Map();
  const parentDiv = document.getElementById("chart_container");

  async function fetchData() {
    try {
      const response = await fetch("/api/core/device_logs/{{device.device_id}}");
      const data = await response.json();
      
      const groupedData = groupBy(data, "data_label");
      
      // Get all unique data labels
      const dataLabels = Object.keys(groupedData);
      
      dataLabels.forEach((dataLabel) => {
        // Sort data by date_time
        groupedData[dataLabel].sort((a, b) => 
          new Date(a.date_time) - new Date(b.date_time)
        );
        
        // Get the last value for this data label
        const lastValue = groupedData[dataLabel][groupedData[dataLabel].length - 1]?.value;
        
        // Extract timestamps and values
        const timestamps = groupedData[dataLabel].map(entry => new Date(entry.date_time));
        const values = groupedData[dataLabel].map(entry => entry.value);
        
        // Check if we already have a plot for this data label
        if (!plotsMap.has(dataLabel)) {
          // Create a div for the chart and the header
          const div = document.createElement("div");
          div.classList = "bg-white p-4";
          
          // Create an h1 element for the last value display
          const header = document.createElement("h1");
          header.id = `lastValueDisplay-${dataLabel}`;
          header.classList = "text-2xl font-bold mt-4 text-gray-900";
          header.innerText = `Current ${dataLabel}: ${lastValue}`;
          div.appendChild(header);
          
          // Create a div for the plot
          const plotDiv = document.createElement("div");
          plotDiv.id = `plot-${dataLabel}`;
          plotDiv.classList = "plotly-graph";
          div.appendChild(plotDiv);
          
          // Add the div to the parent
          parentDiv.appendChild(div);
          
          // Create the trace for the plot
          const trace = {
            x: timestamps,
            y: values,
            type: 'scatter',
            mode: 'lines+markers',
            name: dataLabel,
            line: {
              color: '#3B82F6',
              width: 2
            },
            marker: {
              size: 5
            }
          };
          
          // Create the layout for the plot
          const layout = {
            title: {
              text: dataLabel,
              font: {
                family: 'Arial, sans-serif',
                size: 18,
                color: '#333'
              }
            },
            xaxis: {
              title: 'Time',
              showgrid: true,
              gridcolor: '#e5e5e5'
            },
            yaxis: {
              title: dataLabel,
              showgrid: true,
              gridcolor: '#e5e5e5'
            },
            margin: {
              l: 50,
              r: 20,
              t: 50,
              b: 50
            },
            plot_bgcolor: '#fff',
            paper_bgcolor: '#fff',
            hovermode: 'closest'
          };
          
          const config = {
            responsive: true,
            displayModeBar: false
          };
          
          Plotly.newPlot(`plot-${dataLabel}`, [trace], layout, config);
          
          // Store the plot in the map
          plotsMap.set(dataLabel, true);
        } else {
          // Update existing plot
          const update = {
            x: [timestamps],
            y: [values]
          };
          
          Plotly.update(`plot-${dataLabel}`, update);
        }
        
        // Update the header with the last value
        const headerElement = document.getElementById(`lastValueDisplay-${dataLabel}`);
        if (headerElement && lastValue !== undefined) {
          headerElement.innerText = `Current ${dataLabel}: ${lastValue}`;
        }
      });
      
      // If we have location data, update the map
      if ({% if has_location_data %}true{% else %}false{% endif %}) {
        updateMap(data);
      }
      
    } catch (error) {
      console.error("Error fetching data:", error);
    }
  }

  function groupBy(arr, key) {
    return arr.reduce((acc, obj) => {
      const groupKey = obj[key];
      acc[groupKey] = acc[groupKey] || [];
      acc[groupKey].push(obj);
      return acc;
    }, {});
  }

  function getRandomColor() {
    const letters = "0123456789ABCDEF";
    let color = "#";
    for (let i = 0; i < 6; i++) {
      color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
  }
  
  {% if has_location_data %}
  // Initialize map if we have location data
  let map;
  
  function initMap() {
    // Load the map API (you can use Google Maps, Leaflet, etc.)
    // For this example, I'll use a placeholder
    map = document.getElementById('map');
    map.innerHTML = '<div class="flex items-center justify-center h-full bg-gray-100 text-gray-500">Map will be displayed here</div>';
  }
  
  function updateMap(data) {
    // Update the map with location data
    // This is a placeholder - implement with your preferred map library
    console.log("Would update map with location data");
  }
  
  // Initialize the map
  initMap();
  {% endif %}

  // Initial data fetch
  fetchData();
  
  // Set up periodic data refresh
  setInterval(fetchData, 5000); // Refresh every 5 seconds
</script>
{% endblock content %}
